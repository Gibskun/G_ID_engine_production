{% extends "base.html" %}

{% block title %}Dashboard - Global ID Management System{% endblock %}

{% block content %}
<div class="card">
    <h2>Dashboard</h2>
    <p>Welcome to the Global ID Management System dashboard. Here you can view system statistics, recent activities, and overall health status.</p>
</div>

<!-- Statistics Grid -->
<div class="stats-grid" id="stats-grid">
    <!-- Stats will be loaded dynamically -->
</div>

<!-- System Status -->
<div class="card">
    <h3>System Status</h3>
    <div id="system-status">
        <p class="text-center">Loading system status...</p>
    </div>
</div>

<!-- Recent Activities -->
<div class="card">
    <h3>Recent Activities</h3>
    <div id="recent-activities">
        <p class="text-center">Loading recent activities...</p>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <h3>Quick Actions</h3>
    <div class="text-center">
        <a href="sync" class="btn btn-primary">Manage Sync</a>
        <a href="upload" class="btn btn-success">Upload Excel</a>
        <a href="database-explorer" class="btn btn-secondary">Database Explorer</a>
        <button class="btn btn-warning" onclick="runHealthCheck()">Health Check</button>
    </div>
</div>

<!-- Data View Modal -->
<div class="modal fade" id="dataViewModal" tabindex="-1" aria-labelledby="dataViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataViewModalLabel">Data View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data...</p>
                </div>
                <div id="modal-content">
                    <!-- Data will be loaded here -->
                </div>
                <div id="modal-pagination" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                    <div>
                        <span id="modal-page-info">Page 1 of 1</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="modal-prev-btn" disabled>Previous</button>
                        <button class="btn btn-sm btn-outline-secondary" id="modal-next-btn" disabled>Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let refreshInterval;

async function loadDashboard() {
    try {
        UIUtils.showLoading(document.getElementById('stats-grid'), 'Loading statistics...');
        
        const data = await api.getDashboard();
        
        // Update statistics
        updateStatistics(data);
        
        // Update system status
        updateSystemStatus(data.sync_status);
        
        // Update recent activities
        updateRecentActivities(data.recent_activities);
        
    } catch (error) {
        UIUtils.showAlert('Error loading dashboard: ' + error.message, 'danger');
        console.error('Dashboard load error:', error);
    }
}

function updateStatistics(data) {
    console.log('Dashboard data received:', data); // Debug logging
    
    const statsGrid = document.getElementById('stats-grid');
    
    // Ensure we have the required data structures
    const globalIdStats = data.global_id_stats || { total: 0, active: 0, inactive: 0 };
    const globalIdNonDbStats = data.global_id_non_database_stats || { total: 0, active: 0, inactive: 0 };
    const pegawaiStats = data.pegawai_stats || { total: 0, active: 0, inactive: 0 };
    
    statsGrid.innerHTML = `
        <div class="dashboard-table-container">
            <table class="dashboard-stats-table">
                <thead>
                    <tr>
                        <th>CATEGORY</th>
                        <th>TOTAL RECORDS</th>
                        <th>ACTIVE RECORDS</th>
                        <th>INACTIVE RECORDS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="category-name">Global_ID</td>
                        <td>
                            <span class="stat-number primary">${UIUtils.formatNumber(globalIdStats.total)}</span>
                            <br><button class="btn btn-sm btn-outline-primary view-btn" onclick="viewGlobalIdData('all')">View</button>
                        </td>
                        <td>
                            <span class="stat-number success">${UIUtils.formatNumber(globalIdStats.active)}</span>
                            <br><button class="btn btn-sm btn-outline-success view-btn" onclick="viewGlobalIdData('Active')">View</button>
                        </td>
                        <td>
                            <span class="stat-number warning">${UIUtils.formatNumber(globalIdStats.inactive)}</span>
                            <br><button class="btn btn-sm btn-outline-warning view-btn" onclick="viewGlobalIdData('Non Active')">View</button>
                        </td>
                    </tr>
                    <tr>
                        <td class="category-name">Global_ID_Non_Database</td>
                        <td>
                            <span class="stat-number primary">${UIUtils.formatNumber(globalIdNonDbStats.total)}</span>
                            <br><button class="btn btn-sm btn-outline-primary view-btn" onclick="viewGlobalIdNonDbData('all')">View</button>
                        </td>
                        <td>
                            <span class="stat-number success">${UIUtils.formatNumber(globalIdNonDbStats.active)}</span>
                            <br><button class="btn btn-sm btn-outline-success view-btn" onclick="viewGlobalIdNonDbData('Active')">View</button>
                        </td>
                        <td>
                            <span class="stat-number warning">${UIUtils.formatNumber(globalIdNonDbStats.inactive)}</span>
                            <br><button class="btn btn-sm btn-outline-warning view-btn" onclick="viewGlobalIdNonDbData('Non Active')">View</button>
                        </td>
                    </tr>
                    <tr>
                        <td class="category-name">Employees</td>
                        <td>
                            <span class="stat-number primary">${UIUtils.formatNumber(pegawaiStats.total)}</span>
                            <br><button class="btn btn-sm btn-outline-primary view-btn" onclick="viewEmployeeData('all')">View</button>
                        </td>
                        <td>
                            <span class="stat-number success">${UIUtils.formatNumber(pegawaiStats.active)}</span>
                            <br><button class="btn btn-sm btn-outline-success view-btn" onclick="viewEmployeeData('active')">View</button>
                        </td>
                        <td>
                            <span class="stat-number warning">${UIUtils.formatNumber(pegawaiStats.inactive)}</span>
                            <br><button class="btn btn-sm btn-outline-warning view-btn" onclick="viewEmployeeData('inactive')">View</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
}

function updateSystemStatus(syncStatus) {
    const statusContainer = document.getElementById('system-status');
    
    const globalIdStats = syncStatus.global_id_table;
    const pegawaiStats = syncStatus.pegawai_table;
    const syncNeeded = syncStatus.sync_status.sync_needed;
    
    statusContainer.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Global ID Table</h4>
                <p><strong>Total:</strong> ${UIUtils.formatNumber(globalIdStats.total_records)}</p>
                <p><strong>Active:</strong> ${UIUtils.formatNumber(globalIdStats.active_records)}</p>
                <p><strong>Inactive:</strong> ${UIUtils.formatNumber(globalIdStats.inactive_records)}</p>
            </div>
            <div class="stat-card">
                <h4>Pegawai Table</h4>
                <p><strong>Total:</strong> ${UIUtils.formatNumber(pegawaiStats.total_records)}</p>
                <p><strong>With G_ID:</strong> ${UIUtils.formatNumber(pegawaiStats.with_gid)}</p>
                <p><strong>Without G_ID:</strong> ${UIUtils.formatNumber(pegawaiStats.without_gid)}</p>
            </div>
            <div class="stat-card">
                <h4>Sync Status</h4>
                <p><strong>Status:</strong> ${syncNeeded ? '<span class="status-badge status-inactive">Sync Needed</span>' : '<span class="status-badge status-active">Up to Date</span>'}</p>
                <p><strong>Last Check:</strong> ${UIUtils.formatDate(syncStatus.sync_status.last_check)}</p>
                ${syncNeeded ? '<button class="btn btn-warning btn-sm" onclick="runIncrementalSync()">Run Sync Now</button>' : ''}
            </div>
        </div>
    `;
}

function updateRecentActivities(activities) {
    const activitiesContainer = document.getElementById('recent-activities');
    
    if (activities.length === 0) {
        activitiesContainer.innerHTML = '<p class="text-center text-muted">No recent activities</p>';
        return;
    }
    
    let html = '<div class="table-container"><table><thead><tr>';
    html += '<th>G_ID</th><th>Name</th><th>Action</th><th>Source</th><th>Status</th><th>Timestamp</th>';
    html += '</tr></thead><tbody>';
    
    activities.forEach(activity => {
        html += `
            <tr>
                <td><strong>${activity.G_ID}</strong></td>
                <td>${activity.name}</td>
                <td>${activity.action}</td>
                <td>${UIUtils.createSourceBadge(activity.source)}</td>
                <td>${UIUtils.createStatusBadge(activity.status)}</td>
                <td>${UIUtils.formatDate(activity.timestamp)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    activitiesContainer.innerHTML = html;
}

async function runHealthCheck() {
    const button = event.target;
    UIUtils.showLoading(button, 'Checking...');
    
    try {
        const result = await api.healthCheck();
        UIUtils.showAlert('System is healthy! Database connection: ' + result.database, 'success');
    } catch (error) {
        UIUtils.showAlert('Health check failed: ' + error.message, 'danger');
    } finally {
        UIUtils.hideLoading(button);
    }
}

async function runIncrementalSync() {
    const button = event.target;
    UIUtils.showLoading(button, 'Syncing...');
    
    try {
        const result = await api.incrementalSync();
        UIUtils.showAlert(result.message, result.success ? 'success' : 'warning');
        
        // Reload dashboard data
        setTimeout(loadDashboard, 1000);
        
    } catch (error) {
        UIUtils.showAlert('Sync failed: ' + error.message, 'danger');
    } finally {
        UIUtils.hideLoading(button);
    }
}

function startAutoRefresh() {
    refreshInterval = setInterval(loadDashboard, 30000); // Refresh every 30 seconds
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// Modal functions for View buttons
let currentModalPage = 1;
let currentModalTable = '';
let currentModalStatus = '';

function viewGlobalIdData(status) {
    showDataModal('global_id', status, 'Global ID Records');
}

function viewGlobalIdNonDbData(status) {
    showDataModal('global_id_non_database', status, 'Global ID Non-Database Records');
}

function viewEmployeeData(status) {
    showDataModal('pegawai', status, 'Employee Records');
}

async function showDataModal(table, status, title) {
    currentModalTable = table;
    currentModalStatus = status;
    currentModalPage = 1;
    
    // Update modal title
    document.getElementById('dataViewModalLabel').textContent = `${title} - ${status === 'all' ? 'All Records' : status}`;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('dataViewModal'));
    modal.show();
    
    // Load data
    await loadModalData();
}

async function loadModalData() {
    const loading = document.getElementById('modal-loading');
    const content = document.getElementById('modal-content');
    const pagination = document.getElementById('modal-pagination');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    pagination.style.display = 'none';
    
    try {
        const params = new URLSearchParams({
            page: currentModalPage,
            size: 50
        });
        
        if (currentModalTable) {
            params.append('table', currentModalTable);
        }
        
        if (currentModalStatus && currentModalStatus !== 'all') {
            params.append('status', currentModalStatus);
        }
        
        const response = await api.request(`/database/explorer?${params.toString()}`);
        
        // Get table data
        const tableData = response.dbvendor.tables[currentModalTable];
        if (tableData && tableData.data) {
            displayModalData(tableData);
            updateModalPagination(tableData.pagination);
        } else {
            content.innerHTML = '<p class="text-muted">No data available</p>';
        }
        
    } catch (error) {
        content.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
    } finally {
        loading.style.display = 'none';
        content.style.display = 'block';
        pagination.style.display = 'flex';
    }
}

function displayModalData(tableData) {
    const content = document.getElementById('modal-content');
    
    if (!tableData.data || tableData.data.length === 0) {
        content.innerHTML = '<p class="text-muted">No records found</p>';
        return;
    }
    
    // Create table
    let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
    
    // Table header
    html += '<thead class="table-dark"><tr>';
    const columns = tableData.columns;
    columns.forEach(col => {
        html += `<th>${col.name}</th>`;
    });
    html += '</tr></thead>';
    
    // Table body
    html += '<tbody>';
    tableData.data.forEach(record => {
        html += '<tr>';
        columns.forEach(col => {
            let value = record[col.name];
            if (value === null || value === undefined) {
                value = '-';
            } else if (typeof value === 'string' && value.includes('T')) {
                // Format datetime
                try {
                    value = new Date(value).toLocaleString();
                } catch (e) {
                    // Keep original value if parsing fails
                }
            }
            html += `<td>${value}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    
    content.innerHTML = html;
}

function updateModalPagination(pagination) {
    const pageInfo = document.getElementById('modal-page-info');
    const prevBtn = document.getElementById('modal-prev-btn');
    const nextBtn = document.getElementById('modal-next-btn');
    
    pageInfo.textContent = `Page ${pagination.current_page} of ${pagination.total_pages} (${pagination.total_records} records)`;
    
    prevBtn.disabled = !pagination.has_previous;
    nextBtn.disabled = !pagination.has_next;
    
    prevBtn.onclick = () => {
        if (pagination.has_previous) {
            currentModalPage--;
            loadModalData();
        }
    };
    
    nextBtn.onclick = () => {
        if (pagination.has_next) {
            currentModalPage++;
            loadModalData();
        }
    };
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    startAutoRefresh();
});

// Stop refresh when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        loadDashboard();
        startAutoRefresh();
    }
});
</script>
{% endblock %}