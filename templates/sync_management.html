{% extends "base.html" %}

{% block title %}Sync Management - Global ID Management System{% endblock %}

{% block content %}
<div class="card">
    <h2>Synchronization Management</h2>
    <p>Manage data synchronization between the employee (pegawai) database and the Global ID system.</p>
</div>

<!-- Sync Status Overview -->
<div class="card">
    <h3>Current Sync Status</h3>
    <div id="sync-status-overview">
        <p class="text-center">Loading sync status...</p>
    </div>
</div>

<!-- Sync Actions -->
<div class="card">
    <h3>Sync Operations</h3>
    <div class="text-center">
        <button class="btn btn-primary" onclick="performInitialSync()">
            Initial Sync
        </button>
        <button class="btn btn-success" onclick="performIncrementalSync()">
            Incremental Sync
        </button>
        <button class="btn btn-warning" onclick="refreshSyncStatus()">
            Refresh Status
        </button>
        <button class="btn btn-info" onclick="previewNextGID()">
            Preview Next G_ID
        </button>
    </div>
    
    <div class="mt-3">
        <h4>Sync Operation Descriptions:</h4>
        <ul>
            <li><strong>Initial Sync:</strong> Syncs all records from pegawai database. Use when setting up the system for the first time.</li>
            <li><strong>Incremental Sync:</strong> Syncs only new records and handles soft deletes. Use for regular updates.</li>
            <li><strong>Refresh Status:</strong> Updates the current synchronization status display.</li>
            <li><strong>Preview Next G_ID:</strong> Shows what the next generated G_ID will be.</li>
        </ul>
    </div>
</div>

<!-- Database Management Actions -->
<div class="card">
    <h3>Database Management</h3>
    <div class="text-center">
        <button class="btn btn-success" onclick="showGenerateDummyDataModal()">
            <i class="fas fa-database"></i> Generate Dummy Data
        </button>
        <button class="btn btn-warning" onclick="showResetSequenceModal()">
            <i class="fas fa-redo"></i> Reset G_ID Sequence
        </button>
        <button id="validation-toggle-btn" class="btn btn-info" onclick="toggleValidationRules()">
            <i class="fas fa-shield-alt"></i> <span id="validation-toggle-text">Loading...</span>
        </button>
        <button class="btn btn-danger" onclick="confirmClearAllData()">
            <i class="fas fa-trash"></i> Clear All Data
        </button>
        <button class="btn btn-danger" onclick="confirmReinitializeDatabase()">
            <i class="fas fa-database"></i> Reinitialize Tables
        </button>
    </div>
    
    <div class="mt-3">
        <h4>Database Management Descriptions:</h4>
        <ul>
            <li><strong>Generate Dummy Data:</strong> Populates the database with realistic test data for development and testing purposes. Supports both valid and invalid KTP records for testing validation logic.</li>
            <li><strong>Reset G_ID Sequence:</strong> Manually reset the G_ID sequence to start from a specific point (default: G025AA00). Useful for testing or when you want to restart numbering.</li>
            <li><strong>Validation Rules Toggle:</strong> <span id="validation-status-description">Loading...</span></li>
            <li><strong>Clear All Data:</strong> Deletes all records from global_id, global_id_non_database, and pegawai tables. Automatically resets G_ID sequence to G025AA00. Table structure remains intact.</li>
            <li><strong>Reinitialize Tables:</strong> Executes the SQL schema file (create_schema_sqlserver.sql) to create/recreate the g_id database and all tables with proper structure including passport_id fields.</li>
        </ul>
        <div class="alert alert-warning mt-2">
            <strong>⚠️ Warning:</strong> Clear All Data is destructive and cannot be undone. Reinitialize Tables will create the database schema if it doesn't exist.
        </div>
    </div>
</div>

<!-- Sync Progress -->
<div class="card" id="sync-progress-card" style="display: none;">
    <h3>Sync Progress</h3>
    <div class="progress">
        <div class="progress-bar" style="width: 0%">0%</div>
    </div>
    <div id="sync-progress-details">
        <p>Starting sync operation...</p>
    </div>
</div>

<!-- Sync Results -->
<div class="card" id="sync-results-card" style="display: none;">
    <h3>Sync Results</h3>
    <div id="sync-results-content">
        <!-- Results will be displayed here -->
    </div>
</div>

<!-- Detailed Statistics -->
<div class="card">
    <h3>Detailed Statistics</h3>
    <div id="detailed-statistics">
        <p class="text-center">Loading detailed statistics...</p>
    </div>
</div>

<!-- G_ID Preview Modal will be created dynamically -->
{% endblock %}

{% block scripts %}
<script>
let syncInProgress = false;

async function loadSyncStatus() {
    try {
        const status = await api.getSyncStatus();
        updateSyncStatusOverview(status);
        updateDetailedStatistics(status);
    } catch (error) {
        UIUtils.showAlert('Error loading sync status: ' + error.message, 'danger');
        console.error('Sync status load error:', error);
    }
}

function updateSyncStatusOverview(status) {
    const container = document.getElementById('sync-status-overview');
    
    const globalIdStats = status.global_id_table;
    const pegawaiStats = status.pegawai_table;
    const syncStatus = status.sync_status;
    
    // Check if database is not initialized
    if (syncStatus.database_not_initialized || syncStatus.database_error) {
        const errorMessage = syncStatus.database_not_initialized ? 
            'Database not initialized' : 'Database connection error';
        
        container.innerHTML = `
            <div class="alert alert-warning">
                <h4><i class="fas fa-exclamation-triangle"></i> Database Not Initialized</h4>
                <p><strong>Issue:</strong> ${errorMessage}</p>
                ${syncStatus.tables_missing ? `<p><strong>Missing Tables:</strong> ${syncStatus.tables_missing.join(', ')}</p>` : ''}
                ${syncStatus.error ? `<p><strong>Error:</strong> ${syncStatus.error}</p>` : ''}
                <hr>
                <p><strong>Solution:</strong> Click the "Reinitialize Tables" button below to create the database schema.</p>
                <button class="btn btn-primary mt-2" onclick="confirmReinitializeDatabase()">
                    <i class="fas fa-database"></i> Initialize Database Now
                </button>
            </div>
        `;
        return;
    }
    
    const syncNeeded = syncStatus.sync_needed;
    const statusBadge = syncNeeded ? 
        '<span class="status-badge status-inactive">Sync Needed</span>' : 
        '<span class="status-badge status-active">Up to Date</span>';
    
    container.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Overall Status</h4>
                <p><strong>Status:</strong> ${statusBadge}</p>
                <p><strong>Last Check:</strong> ${UIUtils.formatDate(syncStatus.last_check)}</p>
                ${syncNeeded ? '<p class="text-danger"><strong>Action needed:</strong> Run incremental sync</p>' : '<p class="text-success">All records are synchronized</p>'}
            </div>
            <div class="stat-card">
                <h4>Global ID Table</h4>
                <p><strong>Total Records:</strong> ${UIUtils.formatNumber(globalIdStats.total_records)}</p>
                <p><strong>Active:</strong> ${UIUtils.formatNumber(globalIdStats.active_records)}</p>
                <p><strong>Inactive:</strong> ${UIUtils.formatNumber(globalIdStats.inactive_records)}</p>
            </div>
            <div class="stat-card">
                <h4>Source Database</h4>
                <p><strong>Total Records:</strong> ${UIUtils.formatNumber(pegawaiStats.total_records)}</p>
                <p><strong>With G_ID:</strong> ${UIUtils.formatNumber(pegawaiStats.with_gid)}</p>
                <p><strong>Without G_ID:</strong> ${UIUtils.formatNumber(pegawaiStats.without_gid)}</p>
            </div>
        </div>
    `;
}

function updateDetailedStatistics(status) {
    const container = document.getElementById('detailed-statistics');
    
    const globalIdStats = status.global_id_table;
    const syncStatus = status.sync_status;
    
    // Check if database is not initialized
    if (syncStatus.database_not_initialized || syncStatus.database_error) {
        container.innerHTML = `
            <div class="alert alert-info">
                <h4><i class="fas fa-info-circle"></i> Database Statistics Unavailable</h4>
                <p>Detailed statistics will be available after the database is initialized.</p>
                <p><strong>Required Action:</strong> Initialize the database schema first.</p>
            </div>
        `;
        return;
    }
    
    const databaseStatus = syncStatus.database_initialized ? 'Connected & Initialized' : 'Connected';
    const gidGenerationStatus = syncStatus.database_initialized ? 'Active' : 'Inactive';
    
    container.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <h4>By Source</h4>
                <p><strong>Database Source:</strong> ${UIUtils.formatNumber(globalIdStats.database_source)}</p>
                <p><strong>Excel Source:</strong> ${UIUtils.formatNumber(globalIdStats.excel_source)}</p>
            </div>
            <div class="stat-card">
                <h4>By Status</h4>
                <p><strong>Active Records:</strong> ${UIUtils.formatNumber(globalIdStats.active_records)}</p>
                <p><strong>Inactive Records:</strong> ${UIUtils.formatNumber(globalIdStats.inactive_records)}</p>
            </div>
            <div class="stat-card">
                <h4>System Health</h4>
                <p><strong>Total Capacity:</strong> Unlimited</p>
                <p><strong>G_ID Generation:</strong> ${gidGenerationStatus}</p>
                <p><strong>Database Status:</strong> ${databaseStatus}</p>
            </div>
        </div>
    `;
}

async function performInitialSync() {
    if (syncInProgress) {
        UIUtils.showAlert('Sync operation already in progress. Please wait.', 'warning');
        return;
    }
    
    const confirmed = confirm('Initial sync will process ALL records from the source database. This may take some time. Continue?');
    if (!confirmed) return;
    
    syncInProgress = true;
    
    try {
        showSyncProgress('Starting initial sync...');
        
        updateSyncProgress(20, 'Connecting to source database...');
        
        const result = await api.initialSync();
        
        updateSyncProgress(80, 'Processing results...');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateSyncProgress(100, 'Sync completed!');
        
        showSyncResults('Initial Sync', result);
        
        // Refresh status
        setTimeout(loadSyncStatus, 1000);
        
    } catch (error) {
        updateSyncProgress(0, 'Sync failed!');
        UIUtils.showAlert('Initial sync failed: ' + error.message, 'danger');
    } finally {
        syncInProgress = false;
        setTimeout(hideSyncProgress, 3000);
    }
}

async function performIncrementalSync() {
    if (syncInProgress) {
        UIUtils.showAlert('Sync operation already in progress. Please wait.', 'warning');
        return;
    }
    
    syncInProgress = true;
    
    try {
        showSyncProgress('Starting incremental sync...');
        
        updateSyncProgress(30, 'Checking for new records...');
        
        const result = await api.incrementalSync();
        
        updateSyncProgress(70, 'Handling deletions...');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateSyncProgress(100, 'Sync completed!');
        
        showSyncResults('Incremental Sync', result);
        
        // Refresh status
        setTimeout(loadSyncStatus, 1000);
        
    } catch (error) {
        updateSyncProgress(0, 'Sync failed!');
        UIUtils.showAlert('Incremental sync failed: ' + error.message, 'danger');
    } finally {
        syncInProgress = false;
        setTimeout(hideSyncProgress, 3000);
    }
}

function showSyncProgress(message) {
    document.getElementById('sync-progress-card').style.display = 'block';
    document.getElementById('sync-results-card').style.display = 'none';
    updateSyncProgress(10, message);
}

function updateSyncProgress(percentage, message) {
    UIUtils.updateProgressBar(percentage, `${percentage}%`);
    document.getElementById('sync-progress-details').innerHTML = `<p>${message}</p>`;
}

function hideSyncProgress() {
    document.getElementById('sync-progress-card').style.display = 'none';
}

function showSyncResults(operationType, result) {
    const resultsCard = document.getElementById('sync-results-card');
    const resultsContainer = document.getElementById('sync-results-content');
    
    resultsCard.style.display = 'block';
    
    let html = '';
    
    if (result.success) {
        html += `
            <div class="alert alert-success">
                <h4>${operationType} Completed Successfully!</h4>
                <p>${result.message}</p>
            </div>
        `;
        
        // Show summary statistics
        const summary = result.summary;
        
        if (operationType === 'Initial Sync') {
            html += `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number primary">${summary.total_source_records || 0}</div>
                        <div class="stat-label">Source Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number success">${summary.successful || 0}</div>
                        <div class="stat-label">Successfully Synced</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number warning">${summary.skipped || 0}</div>
                        <div class="stat-label">Skipped (Duplicates)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number danger">${summary.errors ? summary.errors.length : 0}</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            `;
        } else {
            // Incremental sync results
            html += `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number success">${summary.new_records ? summary.new_records.successful : 0}</div>
                        <div class="stat-label">New Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number warning">${summary.deletion_handling ? summary.deletion_handling.marked_inactive : 0}</div>
                        <div class="stat-label">Marked Inactive</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number primary">${summary.total_operations || 0}</div>
                        <div class="stat-label">Total Operations</div>
                    </div>
                </div>
            `;
        }
        
        // Show errors if any
        if (summary.errors && summary.errors.length > 0) {
            html += '<h4>Warnings and Errors:</h4>';
            html += '<div class="alert alert-warning">';
            html += '<ul>';
            summary.errors.forEach(error => {
                html += `<li>${error}</li>`;
            });
            html += '</ul></div>';
        }
        
    } else {
        html += `
            <div class="alert alert-danger">
                <h4>${operationType} Failed</h4>
                <p>${result.message}</p>
            </div>
        `;
    }
    
    html += `
        <div class="text-center">
            <button class="btn btn-primary" onclick="refreshSyncStatus()">Refresh Status</button>

        </div>
    `;
    
    resultsContainer.innerHTML = html;
    
    // Scroll to results
    resultsCard.scrollIntoView({ behavior: 'smooth' });
}

async function refreshSyncStatus() {
    const button = event.target;
    UIUtils.showLoading(button, 'Refreshing...');
    
    try {
        await loadSyncStatus();
        UIUtils.showAlert('Sync status refreshed successfully!', 'success');
    } catch (error) {
        UIUtils.showAlert('Error refreshing sync status: ' + error.message, 'danger');
    } finally {
        UIUtils.hideLoading(button);
    }
}

async function previewNextGID() {
    try {
        const result = await api.previewNextGID();
        
        const modalContent = `
            <div class="text-center">
                <h4>Next G_ID Preview</h4>
                <div class="stat-card">
                    <div class="stat-number primary" style="font-size: 3rem;">${result.next_gid}</div>
                    <div class="stat-label">Next Generated G_ID</div>
                </div>
                
                <h5>Sequence Information:</h5>
                <table class="table">
                    <tr><td><strong>Current Digit:</strong></td><td>${result.sequence_info.current_digit}</td></tr>
                    <tr><td><strong>Current Year:</strong></td><td>${result.sequence_info.current_year}</td></tr>
                    <tr><td><strong>Current Alpha:</strong></td><td>${result.sequence_info.current_alpha_1}${result.sequence_info.current_alpha_2}</td></tr>
                    <tr><td><strong>Current Number:</strong></td><td>${String(result.sequence_info.current_number).padStart(2, '0')}</td></tr>
                    <tr><td><strong>Last Updated:</strong></td><td>${UIUtils.formatDate(result.sequence_info.updated_at)}</td></tr>
                </table>
                
                <p class="text-muted">This is the G_ID that will be assigned to the next new record.</p>
            </div>
        `;
        
        const modalButtons = `
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
            <button class="btn btn-primary" onclick="copyGID('${result.next_gid}')">Copy G_ID</button>
        `;
        
        UIUtils.createModal('G_ID Preview', modalContent, { buttons: modalButtons });
        
    } catch (error) {
        UIUtils.showAlert('Error previewing next G_ID: ' + error.message, 'danger');
    }
}

function copyGID(gid) {
    UIUtils.copyToClipboard(gid);
}

async function confirmClearAllData() {
    const confirmed = confirm(
        '⚠️ WARNING: This will permanently delete ALL data from the following tables:\n\n' +
        '• global_id\n' +
        '• global_id_non_database\n' +
        '• pegawai\n\n' +
        'This action CANNOT be undone!\n\n' +
        'Are you absolutely sure you want to proceed?'
    );
    
    if (!confirmed) return;
    
    const doubleConfirm = confirm(
        'This is your final warning!\n\n' +
        'Clicking "OK" will immediately delete ALL data.\n\n' +
        'Type "DELETE" in the next prompt to confirm.'
    );
    
    if (!doubleConfirm) return;
    
    const typeConfirm = prompt('Type "DELETE" (without quotes) to confirm:');
    if (typeConfirm !== 'DELETE') {
        UIUtils.showAlert('Operation cancelled. Confirmation text did not match.', 'info');
        return;
    }
    
    try {
        UIUtils.showLoading(event.target, 'Deleting...');
        
        const result = await api.request('/data/clear-all?confirm=true', {
            method: 'DELETE'
        });
        
        if (result.success) {
            UIUtils.showAlert(
                `All data has been successfully deleted!\n\n` +
                `Deleted records:\n` +
                `• Global ID: ${result.deleted_counts.global_id}\n` +
                `• Global ID Non-Database: ${result.deleted_counts.global_id_non_database}\n` +
                `• Pegawai: ${result.deleted_counts.pegawai}`,
                'success'
            );
            
            // Refresh the sync status to show empty database
            setTimeout(loadSyncStatus, 1000);
        } else {
            UIUtils.showAlert('Failed to clear data: ' + result.message, 'danger');
        }
        
    } catch (error) {
        UIUtils.showAlert('Error clearing data: ' + error.message, 'danger');
        console.error('Clear data error:', error);
    } finally {
        UIUtils.hideLoading(event.target);
    }
}

async function confirmReinitializeDatabase() {
    const confirmed = confirm(
        '⚠️ DATABASE SCHEMA INITIALIZATION\n\n' +
        'This will execute the SQL schema creation script to:\n' +
        '• Create the g_id database (if it doesn\'t exist)\n' +
        '• Create all tables with proper structure\n' +
        '• Add passport_id fields to all tables\n' +
        '• Insert initial sample data\n' +
        '• Set up indexes and triggers\n\n' +
        'If tables already exist, this may recreate them.\n\n' +
        'Are you sure you want to proceed?'
    );
    
    if (!confirmed) return;
    
    const doubleConfirm = confirm(
        'FINAL CONFIRMATION!\n\n' +
        'This will run the create_schema_sqlserver.sql file.\n' +
        'If database/tables exist, they may be recreated.\n\n' +
        'Type "INITIALIZE" in the next prompt to confirm.'
    );
    
    if (!doubleConfirm) return;
    
    const typeConfirm = prompt('Type "INITIALIZE" (without quotes) to confirm:');
    if (typeConfirm !== 'INITIALIZE') {
        UIUtils.showAlert('Operation cancelled. Confirmation text did not match.', 'info');
        return;
    }
    
    try {
        UIUtils.showLoading(event.target, 'Initializing...');
        
        const result = await api.request('/database/reinitialize?confirm=true', {
            method: 'POST'
        });
        
        if (result.success) {
            let message = `Database schema has been successfully initialized!\n\n`;
            
            if (result.verification?.tables_created) {
                message += `Tables created:\n`;
                result.verification.tables_created.forEach(table => {
                    const count = result.verification.record_counts?.[table] || 0;
                    message += `• ${table} (${count} records)\n`;
                });
            }
            
            message += `\nExecution summary:\n`;
            message += `• SQL batches executed: ${result.execution_results.batches_executed}/${result.execution_results.total_batches}\n`;
            message += `• SQL file: ${result.execution_results.sql_file_path}`;
            
            UIUtils.showAlert(message, 'success');
            
            // Refresh the sync status to show initialized database
            setTimeout(loadSyncStatus, 1000);
        } else {
            UIUtils.showAlert('Failed to initialize database: ' + result.message, 'danger');
        }
        
    } catch (error) {
        UIUtils.showAlert('Error initializing database: ' + error.message, 'danger');
        console.error('Initialize database error:', error);
    } finally {
        UIUtils.hideLoading(event.target);
    }
}

// Generate Dummy Data Functions
function showGenerateDummyDataModal() {
    const modalHtml = `
        <div class="modal fade" id="generateDummyDataModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Generate Dummy Data</h5>
                        <button type="button" class="close" data-bs-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="dummyDataForm">
                            <div class="form-group">
                                <label for="recordCount">Number of Records</label>
                                <input type="number" class="form-control" id="recordCount" value="1000" min="1" max="10000">
                                <small class="form-text text-muted">Generate between 1 and 10,000 test records</small>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="includeInvalidKtp">
                                    <label class="form-check-label" for="includeInvalidKtp">
                                        Include Invalid KTP Records for Testing
                                    </label>
                                </div>
                                <small class="form-text text-muted">Generate some records with invalid KTP lengths to test validation logic</small>
                            </div>
                            
                            <div class="form-group" id="invalidRatioGroup" style="display: none;">
                                <label for="invalidRatio">Invalid KTP Ratio</label>
                                <input type="range" class="form-control-range" id="invalidRatio" min="0.1" max="0.5" step="0.1" value="0.2">
                                <small class="form-text text-muted">Percentage of records with invalid KTP: <span id="ratioValue">20%</span></small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="generateDummyData()">Generate Data</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('generateDummyDataModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Set up event listeners
    const invalidKtpCheckbox = document.getElementById('includeInvalidKtp');
    const invalidRatioGroup = document.getElementById('invalidRatioGroup');
    const invalidRatioSlider = document.getElementById('invalidRatio');
    const ratioValueSpan = document.getElementById('ratioValue');
    
    invalidKtpCheckbox.addEventListener('change', function() {
        invalidRatioGroup.style.display = this.checked ? 'block' : 'none';
    });
    
    invalidRatioSlider.addEventListener('input', function() {
        ratioValueSpan.textContent = Math.round(this.value * 100) + '%';
    });
    
    // Show modal using Bootstrap 5 API
    const modal = new bootstrap.Modal(document.getElementById('generateDummyDataModal'));
    modal.show();
}

async function generateDummyData() {
    const recordCount = document.getElementById('recordCount').value;
    const includeInvalidKtp = document.getElementById('includeInvalidKtp').checked;
    const invalidRatio = document.getElementById('invalidRatio').value;
    
    // Validate inputs
    if (!recordCount || recordCount < 1 || recordCount > 10000) {
        UIUtils.showAlert('Please enter a valid number of records (1-10,000)', 'warning');
        return;
    }
    
    const generateButton = event.target;
    
    // Create progress modal
    showProgressModal('Generating Dummy Data', 'Preparing to generate employee data...');
    
    try {
        // Generate task ID for progress tracking
        const taskId = Date.now().toString();
        
        // Start progress tracking
        const progressInterval = startProgressTracking(taskId);
        
        // Build query parameters
        const params = new URLSearchParams({
            count: recordCount,
            include_invalid_ktp: includeInvalidKtp
        });
        
        if (includeInvalidKtp) {
            params.append('invalid_ktp_ratio', invalidRatio);
        }
        
        const response = await fetch(`/api/v1/generate-dummy-data?${params}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        // Stop progress tracking
        clearInterval(progressInterval);
        
        if (result.success) {
            // Show completion in progress modal
            updateProgressModal(100, `✅ Generation completed in ${result.execution_time}s!`, true);
            
            // Wait a moment for user to see completion
            setTimeout(() => {
                hideProgressModal();
                UIUtils.showAlert(result.message, 'success');
                
                // Close generation modal using Bootstrap 5 API
                const modal = bootstrap.Modal.getInstance(document.getElementById('generateDummyDataModal'));
                if (modal) modal.hide();
                
                // Refresh statistics
                loadSyncStatus();
            }, 1500);
            
        } else {
            hideProgressModal();
            UIUtils.showAlert(result.message || 'Failed to generate dummy data', 'error');
        }
        
    } catch (error) {
        hideProgressModal();
        console.error('Generate dummy data error:', error);
        UIUtils.showAlert('Error generating dummy data: ' + error.message, 'error');
    } finally {
        UIUtils.hideLoading(generateButton);
    }
}

// Progress modal functions
function showProgressModal(title, message) {
    const progressModalHtml = `
        <div class="modal fade" id="progressModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                     id="progressBar" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     aria-valuenow="0" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    0%
                                </div>
                            </div>
                        </div>
                        <div id="progressMessage" class="text-muted">${message}</div>
                        <div id="progressTime" class="small text-muted mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing progress modal if present
    const existingModal = document.getElementById('progressModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', progressModalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
}

function updateProgressModal(progress, message, isComplete = false) {
    const progressBar = document.getElementById('progressBar');
    const progressMessage = document.getElementById('progressMessage');
    const progressTime = document.getElementById('progressTime');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = progress + '%';
        
        // Change color when complete
        if (isComplete) {
            progressBar.className = 'progress-bar bg-success';
        }
    }
    
    if (progressMessage) {
        progressMessage.textContent = message;
    }
    
    if (progressTime) {
        const elapsed = ((Date.now() - window.progressStartTime) / 1000).toFixed(1);
        progressTime.textContent = `Elapsed: ${elapsed}s`;
    }
}

function hideProgressModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
    if (modal) {
        modal.hide();
        // Remove modal element after hiding
        setTimeout(() => {
            const modalElement = document.getElementById('progressModal');
            if (modalElement) modalElement.remove();
        }, 500);
    }
}

function startProgressTracking(taskId) {
    window.progressStartTime = Date.now();
    
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/api/v1/generate-dummy-data/progress/${taskId}`);
            const progress = await response.json();
            
            updateProgressModal(progress.progress, progress.message, progress.completed);
            
            if (progress.completed) {
                clearInterval(interval);
            }
        } catch (error) {
            console.error('Progress tracking error:', error);
        }
    }, 200); // Update every 200ms for smooth animation
    
    return interval;
}

// Reset G_ID Sequence Functions
function showResetSequenceModal() {
    const modalHtml = `
        <div class="modal fade" id="resetSequenceModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Reset G_ID Sequence</h5>
                        <button type="button" class="close" data-bs-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>⚠️ Warning:</strong> This will reset the G_ID sequence. New records will start from the specified G_ID.
                        </div>
                        <form id="resetSequenceForm">
                            <div class="form-group">
                                <label for="sequenceYear">Year (YY)</label>
                                <input type="number" class="form-control" id="sequenceYear" value="25" min="0" max="99">
                                <small class="form-text text-muted">Two-digit year (25 = 2025, etc.)</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="sequenceDigit">Starting Digit (N)</label>
                                <input type="number" class="form-control" id="sequenceDigit" value="0" min="0" max="9">
                                <small class="form-text text-muted">Single digit (0-9)</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Preview Next G_ID:</label>
                                <div class="form-control-plaintext font-weight-bold text-primary" id="previewGID">G025AA00</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="resetGIDSequence()">Reset Sequence</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('resetSequenceModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Set up event listeners for preview update
    const yearInput = document.getElementById('sequenceYear');
    const digitInput = document.getElementById('sequenceDigit');
    const previewDiv = document.getElementById('previewGID');
    
    function updatePreview() {
        const year = yearInput.value.padStart(2, '0');
        const digit = digitInput.value;
        previewDiv.textContent = `G${digit}${year}AA00`;
    }
    
    yearInput.addEventListener('input', updatePreview);
    digitInput.addEventListener('input', updatePreview);
    
    // Show modal using Bootstrap 5 API
    const modal = new bootstrap.Modal(document.getElementById('resetSequenceModal'));
    modal.show();
}

async function resetGIDSequence() {
    const year = document.getElementById('sequenceYear').value;
    const digit = document.getElementById('sequenceDigit').value;
    
    // Validate inputs
    if (!year || year < 0 || year > 99) {
        UIUtils.showAlert('Please enter a valid year (0-99)', 'warning');
        return;
    }
    
    if (!digit || digit < 0 || digit > 9) {
        UIUtils.showAlert('Please enter a valid digit (0-9)', 'warning');
        return;
    }
    
    const resetButton = event.target;
    
    try {
        UIUtils.showLoading(resetButton);
        
        const response = await fetch(`/api/v1/gid/reset-sequence?year=${year}&digit=${digit}&confirm=true`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            UIUtils.showAlert(result.message + `. Next G_ID will be: ${result.next_gid}`, 'success');
            
            // Close modal using Bootstrap 5 API
            const modal = bootstrap.Modal.getInstance(document.getElementById('resetSequenceModal'));
            modal.hide();
            
            // Refresh statistics
            await loadSyncStatus();
            
        } else {
            UIUtils.showAlert('Failed to reset G_ID sequence: ' + result.message, 'danger');
        }
        
    } catch (error) {
        UIUtils.showAlert('Error resetting G_ID sequence: ' + error.message, 'danger');
        console.error('Reset G_ID sequence error:', error);
    } finally {
        UIUtils.hideLoading(resetButton);
    }
}

// Validation Rules Toggle Functions
async function loadValidationStatus() {
    try {
        const response = await fetch('/api/v1/validation-config/status');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            updateValidationUI(result.status);
        } else {
            console.error('Failed to load validation status:', result);
            // Set default state if API call fails
            setDefaultValidationState();
        }
    } catch (error) {
        console.error('Error loading validation status:', error);
        // Set default state if API call fails
        setDefaultValidationState();
    }
}

function setDefaultValidationState() {
    const toggleBtn = document.getElementById('validation-toggle-btn');
    const toggleText = document.getElementById('validation-toggle-text');
    const statusDescription = document.getElementById('validation-status-description');
    
    if (toggleBtn && toggleText && statusDescription) {
        toggleBtn.className = 'btn btn-secondary';
        toggleText.textContent = 'Enable Validation Rules';
        statusDescription.innerHTML = `
            <span class="text-muted"><i class="fas fa-exclamation-triangle"></i> <strong>STATUS UNKNOWN</strong></span><br>
            Unable to load validation status. Please check server connection.
        `;
    }
}

function updateValidationUI(status) {
    const toggleBtn = document.getElementById('validation-toggle-btn');
    const toggleText = document.getElementById('validation-toggle-text');
    const statusDescription = document.getElementById('validation-status-description');
    
    // Check if elements exist before updating
    if (!toggleBtn || !toggleText || !statusDescription) {
        console.error('Validation UI elements not found:', {
            toggleBtn: !!toggleBtn,
            toggleText: !!toggleText,
            statusDescription: !!statusDescription
        });
        return;
    }
    
    const isEnabled = status.strict_validation_enabled;
    
    // Update button appearance
    toggleBtn.className = isEnabled ? 'btn btn-success' : 'btn btn-secondary';
    toggleText.textContent = isEnabled ? 'Disable Validation Rules' : 'Enable Validation Rules';
    
    // Update status description
    if (isEnabled) {
        statusDescription.innerHTML = `
            <span class="text-success"><i class="fas fa-shield-alt"></i> <strong>STRICT VALIDATION ENABLED</strong></span><br>
            Excel/CSV uploads enforce strict rules for ID numbers (16 digits) and passport IDs (8-9 chars, letter+numbers).
            Files with invalid formats will be rejected.
        `;
    } else {
        statusDescription.innerHTML = `
            <span class="text-warning"><i class="fas fa-shield-alt"></i> <strong>VALIDATION RELAXED</strong></span><br>
            Excel/CSV uploads will accept files with non-standard ID number and passport ID formats.
            Use this mode for importing legacy data that doesn't follow current validation rules.
        `;
    }
}

async function toggleValidationRules() {
    const toggleBtn = document.getElementById('validation-toggle-btn');
    
    if (!toggleBtn) {
        console.error('Toggle button not found');
        UIUtils.showAlert('Error: Validation toggle button not found', 'error');
        return;
    }
    
    try {
        UIUtils.showLoading(toggleBtn);
        
        const response = await fetch('/api/v1/validation-config/toggle-strict', {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            updateValidationUI(result.status);
            
            const statusText = result.enabled ? 'enabled' : 'disabled';
            UIUtils.showAlert(`✅ Validation rules ${statusText} successfully!`, 'success');
        } else {
            UIUtils.showAlert('Failed to toggle validation rules', 'error');
        }
        
    } catch (error) {
        UIUtils.showAlert('Error toggling validation rules: ' + error.message, 'error');
        console.error('Toggle validation error:', error);
    } finally {
        UIUtils.hideLoading(toggleBtn);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSyncStatus();
    
    // Add a small delay to ensure elements are rendered
    setTimeout(() => {
        loadValidationStatus();
    }, 100);
});
</script>
{% endblock %}