{% extends "base.html" %}

{% block title %}Sync Management - Global ID Management System{% endblock %}

{% block content %}
<div class="card">
    <h2>Synchronization Management</h2>
    <p>Manage data synchronization between the employee (pegawai) database and the Global ID system.</p>
</div>

<!-- Sync Status Overview -->
<div class="card">
    <h3>Current Sync Status</h3>
    <div id="sync-status-overview">
        <p class="text-center">Loading sync status...</p>
    </div>
</div>

<!-- Sync Actions -->
<div class="card">
    <h3>Sync Operations</h3>
    <div class="text-center">
        <button class="btn btn-primary" onclick="performInitialSync()">
            Initial Sync
        </button>
        <button class="btn btn-success" onclick="performIncrementalSync()">
            Incremental Sync
        </button>
        <button class="btn btn-warning" onclick="refreshSyncStatus()">
            Refresh Status
        </button>
        <button class="btn btn-info" onclick="previewNextGID()">
            Preview Next G_ID
        </button>
    </div>
    
    <div class="mt-3">
        <h4>Sync Operation Descriptions:</h4>
        <ul>
            <li><strong>Initial Sync:</strong> Syncs all records from pegawai database. Use when setting up the system for the first time.</li>
            <li><strong>Incremental Sync:</strong> Syncs only new records and handles soft deletes. Use for regular updates.</li>
            <li><strong>Refresh Status:</strong> Updates the current synchronization status display.</li>
            <li><strong>Preview Next G_ID:</strong> Shows what the next generated G_ID will be.</li>
        </ul>
    </div>
</div>

<!-- Database Management Actions -->
<div class="card">
    <h3>Database Management</h3>
    <div class="text-center">
        <button class="btn btn-success" onclick="showGenerateDummyDataModal()">
            <i class="fas fa-database"></i> Generate Dummy Data
        </button>
        <button class="btn btn-danger" onclick="confirmClearAllData()">
            <i class="fas fa-trash"></i> Clear All Data
        </button>
        <button class="btn btn-danger" onclick="confirmReinitializeDatabase()">
            <i class="fas fa-database"></i> Reinitialize Tables
        </button>
    </div>
    
    <div class="mt-3">
        <h4>Database Management Descriptions:</h4>
        <ul>
            <li><strong>Generate Dummy Data:</strong> Populates the database with realistic test data for development and testing purposes. Supports both valid and invalid KTP records for testing validation logic.</li>
            <li><strong>Clear All Data:</strong> Deletes all records from global_id, global_id_non_database, and pegawai tables. Table structure remains intact.</li>
            <li><strong>Reinitialize Tables:</strong> Executes the SQL schema file (create_schema_sqlserver.sql) to create/recreate the g_id database and all tables with proper structure including passport_id fields.</li>
        </ul>
        <div class="alert alert-warning mt-2">
            <strong>⚠️ Warning:</strong> Clear All Data is destructive and cannot be undone. Reinitialize Tables will create the database schema if it doesn't exist.
        </div>
    </div>
</div>

<!-- Sync Progress -->
<div class="card" id="sync-progress-card" style="display: none;">
    <h3>Sync Progress</h3>
    <div class="progress">
        <div class="progress-bar" style="width: 0%">0%</div>
    </div>
    <div id="sync-progress-details">
        <p>Starting sync operation...</p>
    </div>
</div>

<!-- Sync Results -->
<div class="card" id="sync-results-card" style="display: none;">
    <h3>Sync Results</h3>
    <div id="sync-results-content">
        <!-- Results will be displayed here -->
    </div>
</div>

<!-- Detailed Statistics -->
<div class="card">
    <h3>Detailed Statistics</h3>
    <div id="detailed-statistics">
        <p class="text-center">Loading detailed statistics...</p>
    </div>
</div>

<!-- G_ID Preview Modal will be created dynamically -->
{% endblock %}

{% block scripts %}
<script>
let syncInProgress = false;

async function loadSyncStatus() {
    try {
        const status = await api.getSyncStatus();
        updateSyncStatusOverview(status);
        updateDetailedStatistics(status);
    } catch (error) {
        UIUtils.showAlert('Error loading sync status: ' + error.message, 'danger');
        console.error('Sync status load error:', error);
    }
}

function updateSyncStatusOverview(status) {
    const container = document.getElementById('sync-status-overview');
    
    const globalIdStats = status.global_id_table;
    const pegawaiStats = status.pegawai_table;
    const syncStatus = status.sync_status;
    
    // Check if database is not initialized
    if (syncStatus.database_not_initialized || syncStatus.database_error) {
        const errorMessage = syncStatus.database_not_initialized ? 
            'Database not initialized' : 'Database connection error';
        
        container.innerHTML = `
            <div class="alert alert-warning">
                <h4><i class="fas fa-exclamation-triangle"></i> Database Not Initialized</h4>
                <p><strong>Issue:</strong> ${errorMessage}</p>
                ${syncStatus.tables_missing ? `<p><strong>Missing Tables:</strong> ${syncStatus.tables_missing.join(', ')}</p>` : ''}
                ${syncStatus.error ? `<p><strong>Error:</strong> ${syncStatus.error}</p>` : ''}
                <hr>
                <p><strong>Solution:</strong> Click the "Reinitialize Tables" button below to create the database schema.</p>
                <button class="btn btn-primary mt-2" onclick="confirmReinitializeDatabase()">
                    <i class="fas fa-database"></i> Initialize Database Now
                </button>
            </div>
        `;
        return;
    }
    
    const syncNeeded = syncStatus.sync_needed;
    const statusBadge = syncNeeded ? 
        '<span class="status-badge status-inactive">Sync Needed</span>' : 
        '<span class="status-badge status-active">Up to Date</span>';
    
    container.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Overall Status</h4>
                <p><strong>Status:</strong> ${statusBadge}</p>
                <p><strong>Last Check:</strong> ${UIUtils.formatDate(syncStatus.last_check)}</p>
                ${syncNeeded ? '<p class="text-danger"><strong>Action needed:</strong> Run incremental sync</p>' : '<p class="text-success">All records are synchronized</p>'}
            </div>
            <div class="stat-card">
                <h4>Global ID Table</h4>
                <p><strong>Total Records:</strong> ${UIUtils.formatNumber(globalIdStats.total_records)}</p>
                <p><strong>Active:</strong> ${UIUtils.formatNumber(globalIdStats.active_records)}</p>
                <p><strong>Inactive:</strong> ${UIUtils.formatNumber(globalIdStats.inactive_records)}</p>
            </div>
            <div class="stat-card">
                <h4>Source Database</h4>
                <p><strong>Total Records:</strong> ${UIUtils.formatNumber(pegawaiStats.total_records)}</p>
                <p><strong>With G_ID:</strong> ${UIUtils.formatNumber(pegawaiStats.with_gid)}</p>
                <p><strong>Without G_ID:</strong> ${UIUtils.formatNumber(pegawaiStats.without_gid)}</p>
            </div>
        </div>
    `;
}

function updateDetailedStatistics(status) {
    const container = document.getElementById('detailed-statistics');
    
    const globalIdStats = status.global_id_table;
    const syncStatus = status.sync_status;
    
    // Check if database is not initialized
    if (syncStatus.database_not_initialized || syncStatus.database_error) {
        container.innerHTML = `
            <div class="alert alert-info">
                <h4><i class="fas fa-info-circle"></i> Database Statistics Unavailable</h4>
                <p>Detailed statistics will be available after the database is initialized.</p>
                <p><strong>Required Action:</strong> Initialize the database schema first.</p>
            </div>
        `;
        return;
    }
    
    const databaseStatus = syncStatus.database_initialized ? 'Connected & Initialized' : 'Connected';
    const gidGenerationStatus = syncStatus.database_initialized ? 'Active' : 'Inactive';
    
    container.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <h4>By Source</h4>
                <p><strong>Database Source:</strong> ${UIUtils.formatNumber(globalIdStats.database_source)}</p>
                <p><strong>Excel Source:</strong> ${UIUtils.formatNumber(globalIdStats.excel_source)}</p>
            </div>
            <div class="stat-card">
                <h4>By Status</h4>
                <p><strong>Active Records:</strong> ${UIUtils.formatNumber(globalIdStats.active_records)}</p>
                <p><strong>Inactive Records:</strong> ${UIUtils.formatNumber(globalIdStats.inactive_records)}</p>
            </div>
            <div class="stat-card">
                <h4>System Health</h4>
                <p><strong>Total Capacity:</strong> Unlimited</p>
                <p><strong>G_ID Generation:</strong> ${gidGenerationStatus}</p>
                <p><strong>Database Status:</strong> ${databaseStatus}</p>
            </div>
        </div>
    `;
}

async function performInitialSync() {
    if (syncInProgress) {
        UIUtils.showAlert('Sync operation already in progress. Please wait.', 'warning');
        return;
    }
    
    const confirmed = confirm('Initial sync will process ALL records from the source database. This may take some time. Continue?');
    if (!confirmed) return;
    
    syncInProgress = true;
    
    try {
        showSyncProgress('Starting initial sync...');
        
        updateSyncProgress(20, 'Connecting to source database...');
        
        const result = await api.initialSync();
        
        updateSyncProgress(80, 'Processing results...');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateSyncProgress(100, 'Sync completed!');
        
        showSyncResults('Initial Sync', result);
        
        // Refresh status
        setTimeout(loadSyncStatus, 1000);
        
    } catch (error) {
        updateSyncProgress(0, 'Sync failed!');
        UIUtils.showAlert('Initial sync failed: ' + error.message, 'danger');
    } finally {
        syncInProgress = false;
        setTimeout(hideSyncProgress, 3000);
    }
}

async function performIncrementalSync() {
    if (syncInProgress) {
        UIUtils.showAlert('Sync operation already in progress. Please wait.', 'warning');
        return;
    }
    
    syncInProgress = true;
    
    try {
        showSyncProgress('Starting incremental sync...');
        
        updateSyncProgress(30, 'Checking for new records...');
        
        const result = await api.incrementalSync();
        
        updateSyncProgress(70, 'Handling deletions...');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateSyncProgress(100, 'Sync completed!');
        
        showSyncResults('Incremental Sync', result);
        
        // Refresh status
        setTimeout(loadSyncStatus, 1000);
        
    } catch (error) {
        updateSyncProgress(0, 'Sync failed!');
        UIUtils.showAlert('Incremental sync failed: ' + error.message, 'danger');
    } finally {
        syncInProgress = false;
        setTimeout(hideSyncProgress, 3000);
    }
}

function showSyncProgress(message) {
    document.getElementById('sync-progress-card').style.display = 'block';
    document.getElementById('sync-results-card').style.display = 'none';
    updateSyncProgress(10, message);
}

function updateSyncProgress(percentage, message) {
    UIUtils.updateProgressBar(percentage, `${percentage}%`);
    document.getElementById('sync-progress-details').innerHTML = `<p>${message}</p>`;
}

function hideSyncProgress() {
    document.getElementById('sync-progress-card').style.display = 'none';
}

function showSyncResults(operationType, result) {
    const resultsCard = document.getElementById('sync-results-card');
    const resultsContainer = document.getElementById('sync-results-content');
    
    resultsCard.style.display = 'block';
    
    let html = '';
    
    if (result.success) {
        html += `
            <div class="alert alert-success">
                <h4>${operationType} Completed Successfully!</h4>
                <p>${result.message}</p>
            </div>
        `;
        
        // Show summary statistics
        const summary = result.summary;
        
        if (operationType === 'Initial Sync') {
            html += `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number primary">${summary.total_source_records || 0}</div>
                        <div class="stat-label">Source Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number success">${summary.successful || 0}</div>
                        <div class="stat-label">Successfully Synced</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number warning">${summary.skipped || 0}</div>
                        <div class="stat-label">Skipped (Duplicates)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number danger">${summary.errors ? summary.errors.length : 0}</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            `;
        } else {
            // Incremental sync results
            html += `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number success">${summary.new_records ? summary.new_records.successful : 0}</div>
                        <div class="stat-label">New Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number warning">${summary.deletion_handling ? summary.deletion_handling.marked_inactive : 0}</div>
                        <div class="stat-label">Marked Inactive</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number primary">${summary.total_operations || 0}</div>
                        <div class="stat-label">Total Operations</div>
                    </div>
                </div>
            `;
        }
        
        // Show errors if any
        if (summary.errors && summary.errors.length > 0) {
            html += '<h4>Warnings and Errors:</h4>';
            html += '<div class="alert alert-warning">';
            html += '<ul>';
            summary.errors.forEach(error => {
                html += `<li>${error}</li>`;
            });
            html += '</ul></div>';
        }
        
    } else {
        html += `
            <div class="alert alert-danger">
                <h4>${operationType} Failed</h4>
                <p>${result.message}</p>
            </div>
        `;
    }
    
    html += `
        <div class="text-center">
            <button class="btn btn-primary" onclick="refreshSyncStatus()">Refresh Status</button>

        </div>
    `;
    
    resultsContainer.innerHTML = html;
    
    // Scroll to results
    resultsCard.scrollIntoView({ behavior: 'smooth' });
}

async function refreshSyncStatus() {
    const button = event.target;
    UIUtils.showLoading(button, 'Refreshing...');
    
    try {
        await loadSyncStatus();
        UIUtils.showAlert('Sync status refreshed successfully!', 'success');
    } catch (error) {
        UIUtils.showAlert('Error refreshing sync status: ' + error.message, 'danger');
    } finally {
        UIUtils.hideLoading(button);
    }
}

async function previewNextGID() {
    try {
        const result = await api.previewNextGID();
        
        const modalContent = `
            <div class="text-center">
                <h4>Next G_ID Preview</h4>
                <div class="stat-card">
                    <div class="stat-number primary" style="font-size: 3rem;">${result.next_gid}</div>
                    <div class="stat-label">Next Generated G_ID</div>
                </div>
                
                <h5>Sequence Information:</h5>
                <table class="table">
                    <tr><td><strong>Current Digit:</strong></td><td>${result.sequence_info.current_digit}</td></tr>
                    <tr><td><strong>Current Year:</strong></td><td>${result.sequence_info.current_year}</td></tr>
                    <tr><td><strong>Current Alpha:</strong></td><td>${result.sequence_info.current_alpha_1}${result.sequence_info.current_alpha_2}</td></tr>
                    <tr><td><strong>Current Number:</strong></td><td>${String(result.sequence_info.current_number).padStart(2, '0')}</td></tr>
                    <tr><td><strong>Last Updated:</strong></td><td>${UIUtils.formatDate(result.sequence_info.updated_at)}</td></tr>
                </table>
                
                <p class="text-muted">This is the G_ID that will be assigned to the next new record.</p>
            </div>
        `;
        
        const modalButtons = `
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
            <button class="btn btn-primary" onclick="copyGID('${result.next_gid}')">Copy G_ID</button>
        `;
        
        UIUtils.createModal('G_ID Preview', modalContent, { buttons: modalButtons });
        
    } catch (error) {
        UIUtils.showAlert('Error previewing next G_ID: ' + error.message, 'danger');
    }
}

function copyGID(gid) {
    UIUtils.copyToClipboard(gid);
}

async function confirmClearAllData() {
    const confirmed = confirm(
        '⚠️ WARNING: This will permanently delete ALL data from the following tables:\n\n' +
        '• global_id\n' +
        '• global_id_non_database\n' +
        '• pegawai\n\n' +
        'This action CANNOT be undone!\n\n' +
        'Are you absolutely sure you want to proceed?'
    );
    
    if (!confirmed) return;
    
    const doubleConfirm = confirm(
        'This is your final warning!\n\n' +
        'Clicking "OK" will immediately delete ALL data.\n\n' +
        'Type "DELETE" in the next prompt to confirm.'
    );
    
    if (!doubleConfirm) return;
    
    const typeConfirm = prompt('Type "DELETE" (without quotes) to confirm:');
    if (typeConfirm !== 'DELETE') {
        UIUtils.showAlert('Operation cancelled. Confirmation text did not match.', 'info');
        return;
    }
    
    try {
        UIUtils.showLoading(event.target, 'Deleting...');
        
        const result = await api.request('/data/clear-all?confirm=true', {
            method: 'DELETE'
        });
        
        if (result.success) {
            UIUtils.showAlert(
                `All data has been successfully deleted!\n\n` +
                `Deleted records:\n` +
                `• Global ID: ${result.deleted_counts.global_id}\n` +
                `• Global ID Non-Database: ${result.deleted_counts.global_id_non_database}\n` +
                `• Pegawai: ${result.deleted_counts.pegawai}`,
                'success'
            );
            
            // Refresh the sync status to show empty database
            setTimeout(loadSyncStatus, 1000);
        } else {
            UIUtils.showAlert('Failed to clear data: ' + result.message, 'danger');
        }
        
    } catch (error) {
        UIUtils.showAlert('Error clearing data: ' + error.message, 'danger');
        console.error('Clear data error:', error);
    } finally {
        UIUtils.hideLoading(event.target);
    }
}

async function confirmReinitializeDatabase() {
    const confirmed = confirm(
        '⚠️ DATABASE SCHEMA INITIALIZATION\n\n' +
        'This will execute the SQL schema creation script to:\n' +
        '• Create the g_id database (if it doesn\'t exist)\n' +
        '• Create all tables with proper structure\n' +
        '• Add passport_id fields to all tables\n' +
        '• Insert initial sample data\n' +
        '• Set up indexes and triggers\n\n' +
        'If tables already exist, this may recreate them.\n\n' +
        'Are you sure you want to proceed?'
    );
    
    if (!confirmed) return;
    
    const doubleConfirm = confirm(
        'FINAL CONFIRMATION!\n\n' +
        'This will run the create_schema_sqlserver.sql file.\n' +
        'If database/tables exist, they may be recreated.\n\n' +
        'Type "INITIALIZE" in the next prompt to confirm.'
    );
    
    if (!doubleConfirm) return;
    
    const typeConfirm = prompt('Type "INITIALIZE" (without quotes) to confirm:');
    if (typeConfirm !== 'INITIALIZE') {
        UIUtils.showAlert('Operation cancelled. Confirmation text did not match.', 'info');
        return;
    }
    
    try {
        UIUtils.showLoading(event.target, 'Initializing...');
        
        const result = await api.request('/database/reinitialize?confirm=true', {
            method: 'POST'
        });
        
        if (result.success) {
            let message = `Database schema has been successfully initialized!\n\n`;
            
            if (result.verification?.tables_created) {
                message += `Tables created:\n`;
                result.verification.tables_created.forEach(table => {
                    const count = result.verification.record_counts?.[table] || 0;
                    message += `• ${table} (${count} records)\n`;
                });
            }
            
            message += `\nExecution summary:\n`;
            message += `• SQL batches executed: ${result.execution_results.batches_executed}/${result.execution_results.total_batches}\n`;
            message += `• SQL file: ${result.execution_results.sql_file_path}`;
            
            UIUtils.showAlert(message, 'success');
            
            // Refresh the sync status to show initialized database
            setTimeout(loadSyncStatus, 1000);
        } else {
            UIUtils.showAlert('Failed to initialize database: ' + result.message, 'danger');
        }
        
    } catch (error) {
        UIUtils.showAlert('Error initializing database: ' + error.message, 'danger');
        console.error('Initialize database error:', error);
    } finally {
        UIUtils.hideLoading(event.target);
    }
}

// Generate Dummy Data Functions
function showGenerateDummyDataModal() {
    const modalHtml = `
        <div class="modal fade" id="generateDummyDataModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Generate Dummy Data</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="dummyDataForm">
                            <div class="form-group">
                                <label for="recordCount">Number of Records</label>
                                <input type="number" class="form-control" id="recordCount" value="1000" min="1" max="10000">
                                <small class="form-text text-muted">Generate between 1 and 10,000 test records</small>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="includeInvalidKtp">
                                    <label class="form-check-label" for="includeInvalidKtp">
                                        Include Invalid KTP Records for Testing
                                    </label>
                                </div>
                                <small class="form-text text-muted">Generate some records with invalid KTP lengths to test validation logic</small>
                            </div>
                            
                            <div class="form-group" id="invalidRatioGroup" style="display: none;">
                                <label for="invalidRatio">Invalid KTP Ratio</label>
                                <input type="range" class="form-control-range" id="invalidRatio" min="0.1" max="0.5" step="0.1" value="0.2">
                                <small class="form-text text-muted">Percentage of records with invalid KTP: <span id="ratioValue">20%</span></small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="generateDummyData()">Generate Data</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('generateDummyDataModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Set up event listeners
    const invalidKtpCheckbox = document.getElementById('includeInvalidKtp');
    const invalidRatioGroup = document.getElementById('invalidRatioGroup');
    const invalidRatioSlider = document.getElementById('invalidRatio');
    const ratioValueSpan = document.getElementById('ratioValue');
    
    invalidKtpCheckbox.addEventListener('change', function() {
        invalidRatioGroup.style.display = this.checked ? 'block' : 'none';
    });
    
    invalidRatioSlider.addEventListener('input', function() {
        ratioValueSpan.textContent = Math.round(this.value * 100) + '%';
    });
    
    // Show modal
    $('#generateDummyDataModal').modal('show');
}

async function generateDummyData() {
    const recordCount = document.getElementById('recordCount').value;
    const includeInvalidKtp = document.getElementById('includeInvalidKtp').checked;
    const invalidRatio = document.getElementById('invalidRatio').value;
    
    // Validate inputs
    if (!recordCount || recordCount < 1 || recordCount > 10000) {
        UIUtils.showAlert('Please enter a valid number of records (1-10,000)', 'warning');
        return;
    }
    
    const generateButton = event.target;
    
    try {
        UIUtils.showLoading(generateButton);
        
        // Build query parameters
        const params = new URLSearchParams({
            count: recordCount,
            include_invalid_ktp: includeInvalidKtp
        });
        
        if (includeInvalidKtp) {
            params.append('invalid_ktp_ratio', invalidRatio);
        }
        
        const response = await fetch(`/api/v1/generate-dummy-data?${params}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            UIUtils.showAlert(result.message, 'success');
            
            // Close modal
            $('#generateDummyDataModal').modal('hide');
            
            // Refresh statistics
            await loadSyncStatus();
            
        } else {
            UIUtils.showAlert('Failed to generate dummy data: ' + result.message, 'danger');
        }
        
    } catch (error) {
        UIUtils.showAlert('Error generating dummy data: ' + error.message, 'danger');
        console.error('Generate dummy data error:', error);
    } finally {
        UIUtils.hideLoading(generateButton);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSyncStatus();
});
</script>
{% endblock %}